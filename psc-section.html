<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSC / AASHTO Type Section Properties</title>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(255,255,255,0.08);
      --panel2: rgba(255,255,255,0.06);
      --line: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);

      --canvasBg: rgba(0,0,0,0.30);
      --shapeFill: rgba(125, 211, 252, 0.35);
      --shapeStroke: rgba(255,255,255,0.85);
      --axis: rgba(255, 214, 102, 0.95);

      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --shadow: 0 24px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(167,139,250,.16), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 44px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;}
    .dot{width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 6px rgba(125,211,252,.10);}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);text-decoration:none;color:var(--text);
      font-weight:600;font-size:14px; cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071022;
    }
    .grid{display:grid;grid-template-columns:420px 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow);
      padding:16px; backdrop-filter: blur(10px);
    }
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.55}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);outline:none;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted)}
    .warn{color:#ffd27d;font-size:13px;margin-top:10px}
    .ok{color:#a7f3d0;font-size:13px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
    td:nth-child(1){color:var(--muted);width:55%}
    .svgBox{
      border:1px solid var(--line);border-radius:16px;background:var(--canvasBg);
      overflow:hidden;
    }
    .small{font-size:12px;color:var(--muted);margin-top:8px}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand"><span class="dot"></span> PSC / AASHTO-Type Section Properties (Tapered)</div>
    <a class="btn" href="index.html">← Back to Home</a>
  </div>

  <div class="grid">
    <!-- Inputs -->
    <div class="panel">
      <h1>Inputs (mm)</h1>
      <div class="muted">
        This models an AASHTO-Type tapered section using a polygon outline:
        Top flange → top taper → web → bottom taper → bottom flange.
        Outputs A, ȳ, Ixx, Ztop/Zbot, plus concrete quantity per meter.
      </div>

      <div class="row">
        <div class="field">
          <label>Total depth, D</label>
          <input id="D" type="number" value="1372" min="1" step="1">
        </div>
        <div class="field">
          <label>Web thickness, tw</label>
          <input id="tw" type="number" value="203" min="1" step="1">
        </div>

        <div class="field">
          <label>Top flange width, bt</label>
          <input id="bt" type="number" value="508" min="1" step="1">
        </div>
        <div class="field">
          <label>Top flange thickness, tt</label>
          <input id="tt" type="number" value="200" min="1" step="1">
        </div>

        <div class="field">
          <label>Bottom flange width, bb</label>
          <input id="bb" type="number" value="660" min="1" step="1">
        </div>
        <div class="field">
          <label>Bottom flange thickness, tb</label>
          <input id="tb" type="number" value="220" min="1" step="1">
        </div>

        <div class="field">
          <label>Top taper height, ht</label>
          <input id="ht" type="number" value="250" min="0" step="1">
        </div>
        <div class="field">
          <label>Bottom taper height, hb</label>
          <input id="hb" type="number" value="300" min="0" step="1">
        </div>

        <div class="field">
          <label>Concrete density (kN/m³)</label>
          <input id="gamma" type="number" value="25" min="1" step="0.5">
        </div>
        <div class="field">
          <label>Report title</label>
          <input id="rtitle" type="text" value="PSC Girder Section Property Report">
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="calcBtn" type="button">Calculate</button>
        <button class="btn" id="pdfBtn" type="button">Download PDF</button>
        <button class="btn" id="dxfBtn" type="button">Download DXF</button>
        <button class="btn" id="resetBtn" type="button">Reset</button>
        <span class="pill">Units: mm, mm², mm⁴, mm³</span>
      </div>

      <div id="msg"></div>

      <div class="small">
        If you want the exact AASHTO Type IV proportions (including fillets/chamfers),
        we can add optional corner cuts later. For section properties, the tapered polygon is already very accurate.
      </div>
    </div>

    <!-- Report Area -->
    <div class="panel" id="reportArea">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>Section (graphic)</h1>
          <div class="muted">Section shown as tapered polygon + centroid axis + dimensions.</div>
        </div>
        <div class="muted" id="stamp"></div>
      </div>

      <div class="svgBox" style="margin-top:10px;">
        <svg id="svg" viewBox="0 0 900 520" width="100%" height="520" xmlns="http://www.w3.org/2000/svg">
          <!-- Marker defs moved HERE (safe) -->
         <defs>
  <!-- Arrow for START (points inward) -->
  <marker id="arrStart" markerWidth="10" markerHeight="10" refX="6" refY="3"
    orient="auto" markerUnits="strokeWidth">
    <path d="M6,0 L0,3 L6,6 Z" fill="rgba(255,255,255,.85)" />
  </marker>

  <!-- Arrow for END (points inward) -->
  <marker id="arrEnd" markerWidth="10" markerHeight="10" refX="0" refY="3"
    orient="auto" markerUnits="strokeWidth">
    <path d="M0,0 L6,3 L0,6 Z" fill="rgba(255,255,255,.85)" />
  </marker>
</defs>

          <g id="shape"></g>
          <g id="axis"></g>
          <g id="dims"></g>
        </svg>
      </div>

      <div style="margin-top:14px;">
        <h1>Results</h1>
        <table>
          <tbody>
            <tr><td>Area, A</td><td id="A">—</td></tr>
            <tr><td>Centroid from bottom, ȳ</td><td id="ybar">—</td></tr>
            <tr><td>Ixx about centroid</td><td id="Ixx">—</td></tr>
            <tr><td>Section modulus at top, Ztop</td><td id="Ztop">—</td></tr>
            <tr><td>Section modulus at bottom, Zbot</td><td id="Zbot">—</td></tr>
            <tr><td>Concrete volume per meter</td><td id="Vpm">—</td></tr>
            <tr><td>Self weight per meter</td><td id="Wpm">—</td></tr>
          </tbody>
        </table>
        <div class="small">PDF includes: inputs + section graphic + results + quantity per meter.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const el = (id) => document.getElementById(id);

  function nowStamp(){
    return new Date().toLocaleString();
  }
  function fmt(x, decimals=1) {
    if (!isFinite(x)) return "—";
    return x.toLocaleString(undefined, { maximumFractionDigits: decimals });
  }

  function validate(d){
    const errs = [];
    if ([d.D,d.tw,d.bt,d.tt,d.bb,d.tb].some(v => v <= 0)) errs.push("All main dimensions must be > 0.");
    if (d.bt < d.tw) errs.push("Top flange width bt must be ≥ web thickness tw.");
    if (d.bb < d.tw) errs.push("Bottom flange width bb must be ≥ web thickness tw.");
    if (d.ht < 0 || d.hb < 0) errs.push("Taper heights must be ≥ 0.");
    if (d.D <= d.tt + d.tb + d.ht + d.hb) errs.push("D must be > (tt + tb + ht + hb). Reduce taper heights or flange thickness.");
    if (d.gamma <= 0) errs.push("Concrete density must be > 0.");
    return errs;
  }

  // Build polygon points (x,y) in mm, symmetric about centerline.
  // Origin: bottom at y=0, centerline at x=0.
  function buildPolygon(d){
    // y-levels
    const y0 = 0;
    const y1 = d.tb;
    const y2 = y1 + d.hb;          // end of bottom taper, start of web
    const y3 = d.D - d.tt - d.ht;  // end of web, start of top taper
    const y4 = d.D - d.tt;         // end of top taper, start of top flange
    const y5 = d.D;

    // half-widths
    const hbb = d.bb / 2;
    const htw = d.tw / 2;
    const hbt = d.bt / 2;

    const right = [
      { x: hbb, y: y0 },
      { x: hbb, y: y1 },
      { x: htw, y: y2 },
      { x: htw, y: y3 },
      { x: hbt, y: y4 },
      { x: hbt, y: y5 },
      { x: -hbt, y: y5 },
    ];

    const leftDown = [
      { x: -hbt, y: y4 },
      { x: -htw, y: y3 },
      { x: -htw, y: y2 },
      { x: -hbb, y: y1 },
      { x: -hbb, y: y0 }
    ];

    return [...right, ...leftDown];
  }

  // Polygon area, centroid, and second moment about x-axis through origin (y=0)
  function polyProps(poly){
    let A2 = 0;
    let Cx6A = 0;
    let Cy6A = 0;
    let Ix12 = 0;

    const n = poly.length;
    for (let i=0; i<n; i++){
      const p0 = poly[i];
      const p1 = poly[(i+1)%n];
      const cross = p0.x*p1.y - p1.x*p0.y;
      A2 += cross;
      Cx6A += (p0.x + p1.x) * cross;
      Cy6A += (p0.y + p1.y) * cross;
      Ix12 += (p0.y*p0.y + p0.y*p1.y + p1.y*p1.y) * cross;
    }

    const A = A2 / 2;
    const Cx = Cx6A / (6*A2);
    const Cy = Cy6A / (6*A2);
    const Ix0 = Ix12 / 12;

    const sign = (A < 0) ? -1 : 1;
    return {
      A: Math.abs(A),
      Cx: Cx * sign,
      Cy: Cy * sign,
      Ix0: Ix0 * sign
    };
  }

  function compute(){
    const d = {
      D: +el("D").value,
      tw: +el("tw").value,
      bt: +el("bt").value,
      tt: +el("tt").value,
      bb: +el("bb").value,
      tb: +el("tb").value,
      ht: +el("ht").value,
      hb: +el("hb").value,
      gamma: +el("gamma").value
    };

    const errs = validate(d);
    const msg = el("msg");
    msg.innerHTML = "";
    if (errs.length){
      msg.innerHTML = `<div class="warn">⚠ ${errs.join(" ")}</div>`;
      return null;
    }
    msg.innerHTML = `<div class="ok">✓ Inputs look OK</div>`;

    const poly = buildPolygon(d);
    const props = polyProps(poly);

    const Ixx = props.Ix0 - props.A * props.Cy * props.Cy;

    const ybar = props.Cy;
    const Ztop = Ixx / (d.D - ybar);
    const Zbot = Ixx / (ybar);

    const Vpm = props.A / 1e6;
    const Wpm = d.gamma * Vpm;

    return {d, poly, A: props.A, ybar, Ixx, Ztop, Zbot, Vpm, Wpm};
  }

  // --- SVG helpers for dimensions ---
  function svgLine(x1,y1,x2,y2,stroke="rgba(255,255,255,.7)",w=2,dash=""){
    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"
      stroke="${stroke}" stroke-width="${w}" ${dash?`stroke-dasharray="${dash}"`:``} />`;
  }
  function svgText(x,y,txt,anchor="middle"){
    return `<text x="${x}" y="${y}" fill="rgba(255,255,255,.85)"
      font-size="14" text-anchor="${anchor}" font-family="system-ui, Arial">${txt}</text>`;
  }
  function dimH(x1, x2, y, ext=18, label=""){
    const yExtTop = y - ext;
    return `
      ${svgLine(x1,y,x1,yExtTop)}
      ${svgLine(x2,y,x2,yExtTop)}
      <line x1="${x1}" y1="${yExtTop}" x2="${x2}" y2="${yExtTop}"
        stroke="rgba(255,255,255,.8)" stroke-width="2"
        marker-start="url(#arrStart)" marker-end="url(#arrEnd)"/>
      ${svgText((x1+x2)/2, yExtTop-6, label)}
    `;
  }
  function dimV(x, y1, y2, ext=18, label=""){
    const xExt = x + ext;
    return `
      ${svgLine(x,y1,xExt,y1)}
      ${svgLine(x,y2,xExt,y2)}
      <line x1="${xExt}" y1="${y1}" x2="${xExt}" y2="${y2}"
        stroke="rgba(255,255,255,.8)" stroke-width="2"
        marker-start="url(#arrStart)" marker-end="url(#arrEnd)"/>
      ${svgText(xExt+6, (y1+y2)/2 + 5, label, "start")}
    `;
  }

  function draw(res){
    if (!res) return;
    const {d, poly, ybar} = res;

    const gShape = el("shape");
    const gAxis  = el("axis");
    const gDims  = el("dims");
    gShape.innerHTML = "";
    gAxis.innerHTML  = "";
    gDims.innerHTML  = "";

    const W = 900, H = 520, pad = 70;

    const maxX = Math.max(...poly.map(p => Math.abs(p.x)));
    const maxY = d.D;

    const sx = (W - 2*pad) / (2*maxX);
    const sy = (H - 2*pad) / (maxY);
    const s = Math.min(sx, sy);

    const secW = 2*maxX*s;
    const secH = maxY*s;
    const x0 = (W - secW)/2;
    const y0 = (H - secH)/2;

    const X = (x) => x0 + (x + maxX) * s;
    const Y = (y) => y0 + (maxY - y) * s;

    const pts = poly.map(p => `${X(p.x)},${Y(p.y)}`).join(" ");

    gShape.insertAdjacentHTML("beforeend", `
      <polygon points="${pts}" fill="var(--shapeFill)" stroke="var(--shapeStroke)" stroke-width="2"/>
    `);

    gAxis.insertAdjacentHTML("beforeend", `
      <line x1="${X(-maxX)}" y1="${Y(ybar)}" x2="${X(maxX)}" y2="${Y(ybar)}"
            stroke="var(--axis)" stroke-width="3" stroke-dasharray="10,8"/>
      <circle cx="${X(0)}" cy="${Y(ybar)}" r="5" fill="var(--axis)"/>
    `);

    // Dimensions
    const y00 = 0;
    const y1 = d.tb;
    const y2 = y1 + d.hb;
    const y3 = d.D - d.tt - d.ht;
    const y4 = d.D - d.tt;
    const y5 = d.D;

    const hbb = d.bb/2;
    const htw = d.tw/2;
    const hbt = d.bt/2;

    const xLeftTop  = X(-hbt), xRightTop  = X(hbt);
    const xLeftWeb  = X(-htw), xRightWeb  = X(htw);
    const xLeftBot  = X(-hbb), xRightBot  = X(hbb);

    gDims.insertAdjacentHTML("beforeend",
      dimH(xLeftTop, xRightTop, Y(y5) + 40, 18, `bt = ${d.bt} mm`)
    );

    gDims.insertAdjacentHTML("beforeend",
      dimH(xLeftWeb, xRightWeb, Y((y2+y3)/2) + 40, 18, `tw = ${d.tw} mm`)
    );

    // FIX: keep bottom width dimension inside viewbox
    gDims.insertAdjacentHTML("beforeend",
      dimH(xLeftBot, xRightBot, Y(y00) + 40, 18, `bb = ${d.bb} mm`)
    );

    // overall depth at left
    gDims.insertAdjacentHTML("beforeend",
      dimV(X(-hbb) - 60, Y(y00), Y(y5), -18, `D = ${d.D} mm`)
    );

    // segment heights at right
    gDims.insertAdjacentHTML("beforeend",
      dimV(X(hbb) + 30, Y(y00), Y(y1), 18, `tb = ${d.tb}`)
    );
    gDims.insertAdjacentHTML("beforeend",
      dimV(X(hbb) + 30, Y(y1), Y(y2), 18, `hb = ${d.hb}`)
    );
    gDims.insertAdjacentHTML("beforeend",
      dimV(X(hbb) + 30, Y(y3), Y(y4), 18, `ht = ${d.ht}`)
    );
    gDims.insertAdjacentHTML("beforeend",
      dimV(X(hbb) + 30, Y(y4), Y(y5), 18, `tt = ${d.tt}`)
    );

    // labels
    gDims.insertAdjacentHTML("beforeend", `
      <text x="18" y="30" fill="rgba(255,255,255,.85)" font-size="14">D=${d.D} mm</text>
      <text x="18" y="52" fill="rgba(255,255,255,.75)" font-size="13">
        bt=${d.bt}, tt=${d.tt}, tw=${d.tw}, bb=${d.bb}, tb=${d.tb}, ht=${d.ht}, hb=${d.hb} (mm)
      </text>
    `);
  }

  function updateUI(){
    const res = compute();
    if (!res) return;

    el("A").textContent    = `${fmt(res.A,0)} mm²`;
    el("ybar").textContent = `${fmt(res.ybar,1)} mm`;
    el("Ixx").textContent  = `${res.Ixx.toExponential(3)} mm⁴`;
    el("Ztop").textContent = `${res.Ztop.toExponential(3)} mm³`;
    el("Zbot").textContent = `${res.Zbot.toExponential(3)} mm³`;

    el("Vpm").textContent  = `${fmt(res.Vpm,6)} m³/m`;
    el("Wpm").textContent  = `${fmt(res.Wpm,3)} kN/m`;

    el("stamp").textContent = `Generated: ${nowStamp()}`;
    draw(res);
  }

  async function downloadPDF(){
    const res = compute();
    if (!res) return;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

    const margin = 12;
    let y = margin;

    pdf.setFont("helvetica","bold");
    pdf.setFontSize(14);
    pdf.text(el("rtitle").value || "Section Property Report", margin, y);
    y += 7;

    pdf.setFont("helvetica","normal");
    pdf.setFontSize(10);
    pdf.text(`Generated: ${nowStamp()}`, margin, y);
    y += 8;

    pdf.setFont("helvetica","bold"); pdf.text("Inputs (mm)", margin, y); y += 6;
    pdf.setFont("helvetica","normal");

    const d = res.d;
    const inputLines = [
      `D=${d.D}, tw=${d.tw}`,
      `bt=${d.bt}, tt=${d.tt}`,
      `bb=${d.bb}, tb=${d.tb}`,
      `Top taper ht=${d.ht}, Bottom taper hb=${d.hb}`,
      `Concrete density = ${d.gamma} kN/m³`
    ];
    inputLines.forEach(line => { pdf.text(line, margin, y); y += 5; });
    y += 4;

    pdf.setFont("helvetica","bold"); pdf.text("Results", margin, y); y += 6;
    pdf.setFont("helvetica","normal");
    const resLines = [
      `Area A = ${Math.round(res.A)} mm²`,
      `Centroid ȳ (from bottom) = ${res.ybar.toFixed(1)} mm`,
      `Ixx (about centroid) = ${res.Ixx.toExponential(3)} mm⁴`,
      `Ztop = ${res.Ztop.toExponential(3)} mm³`,
      `Zbot = ${res.Zbot.toExponential(3)} mm³`,
      `Concrete volume per meter = ${(res.Vpm).toFixed(6)} m³/m`,
      `Self weight per meter = ${(res.Wpm).toFixed(3)} kN/m`
    ];
    resLines.forEach(line => { pdf.text(line, margin, y); y += 5; });

    y += 4;

    const report = el("reportArea");
    const canvas = await html2canvas(report, { scale: 2, backgroundColor: "#0b1220" });
    const imgData = canvas.toDataURL("image/png");

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const maxW = pageW - 2*margin;
    const imgW = maxW;
    const imgH = (canvas.height / canvas.width) * imgW;

    if (y + imgH > pageH - margin) {
      pdf.addPage();
      y = margin;
    }
    pdf.addImage(imgData, "PNG", margin, y, imgW, imgH);

    pdf.save("psc_section_report.pdf");
  }

  function downloadDXF(){
    const res = compute();
    if(!res) return;

    const pts = res.poly;

    const NL = "\r\n";
    let dxf = "";
    const add = s => dxf += s + NL;

    add("0"); add("SECTION");
    add("2"); add("HEADER");
    add("9"); add("$INSUNITS");
    add("70"); add("4");
    add("0"); add("ENDSEC");

    add("0"); add("SECTION");
    add("2"); add("TABLES");

    add("0"); add("TABLE");
    add("2"); add("LAYER");
    add("70"); add("1");

    add("0"); add("LAYER");
    add("2"); add("0");
    add("70"); add("0");
    add("62"); add("7");
    add("6"); add("CONTINUOUS");

    add("0"); add("ENDTAB");
    add("0"); add("ENDSEC");

    add("0"); add("SECTION");
    add("2"); add("ENTITIES");

    add("0"); add("POLYLINE");
    add("8"); add("0");
    add("66"); add("1");
    add("70"); add("1");

    pts.forEach(p=>{
      add("0"); add("VERTEX");
      add("8"); add("0");
      add("10"); add(p.x.toFixed(3));
      add("20"); add(p.y.toFixed(3));
      add("30"); add("0");
    });

    add("0"); add("SEQEND");
    add("0"); add("ENDSEC");
    add("0"); add("EOF");

    const blob = new Blob([dxf],{type:"application/dxf"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="psc_section.dxf";
    a.click();
  }

  el("calcBtn").addEventListener("click", updateUI);
  el("pdfBtn").addEventListener("click", downloadPDF);
  el("dxfBtn").addEventListener("click", downloadDXF);

  el("resetBtn").addEventListener("click", () => {
    el("D").value = 1372;
    el("tw").value = 203;
    el("bt").value = 508;
    el("tt").value = 200;
    el("bb").value = 660;
    el("tb").value = 220;
    el("ht").value = 250;
    el("hb").value = 300;
    el("gamma").value = 25;
    el("rtitle").value = "PSC Girder Section Property Report";
    updateUI();
  });

  updateUI();
</script>
</body>
</html>
